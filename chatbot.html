<!DOCTYPE html>
<html>
<head>
  <title>TalkJS Data API Example</title>
  <script type="module">
    import { getTalkSession } from 'https://cdn.jsdelivr.net/npm/@talkjs/core@1.5.8';
    // --- CONFIGURATION ---
    const APP_ID = "tCc397Q9"; // <--- PUT YOUR DURHACK APP ID HERE
    // -------------------

    const urlParams = new URLSearchParams(window.location.search);
    const currentUserId = urlParams.get('user');

    if (!currentUserId) {
      document.body.innerHTML = "<h1>Error: Who are you?</h1><p>Set a user in the URL, like this: <code>?user=alice</code></p>";
      throw new Error("No user specified in URL");
    }

    // Hardcoded user data for this example
    const users = {
      alice: {
        id: "alice",
        name: "Alice",
        // You can add email, photoUrl, etc. here
      },
      bob: {
        id: "bob",
        name: "Bob"
      }
    };

    const me = users[currentUserId];
    const other = currentUserId === 'alice' ? users.bob : users.alice;

    document.getElementById("title").innerText = `Logged in as ${me.name}`;

    // A simple way to get a consistent conversation ID for a 1-on-1 chat
    const conversationId = [me.id, other.id].sort().join("--");

    const session = getTalkSession({
      // @ts-ignore
      host: "durhack.talkjs.com", // Don't forget this bit!
      appId: APP_ID,
      userId: me.id
    });

    await session.user(me.id).createIfNotExists(me);
    await session.user(other.id).createIfNotExists(other);

    const conversation = session.conversation(conversationId);
    await conversation.createIfNotExists();
    await conversation.participant(other.id).createIfNotExists();

    const messageLog = document.getElementById("message-log");

    conversation.subscribeMessages((messages, loadedAll) => {
        if(messages === null) {
            messageLog.textContent = "Couldn't load messages. Are you a participant?";
            return;
        }
        // messages are newest-first, so we make a copy and then reverse it for display
        const formattedMessages = [...messages].reverse().map(m => {
            const senderName = m.sender?.name || 'System';
            return `${senderName}: ${m.plaintext}`;
        }).join('\n');
        messageLog.textContent = formattedMessages;
    });

    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");

    sendButton.addEventListener("click", () => {
        const text = messageInput.value;
        if (text) {
            conversation.send(text);
            messageInput.value = "";
        }
    });
  </script>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; height: 95vh; }
    #message-log { flex-grow: 1; white-space: pre-wrap; border: 1px solid #ccc; padding: 1rem; overflow-y: auto; }
    #input-area { display: flex; }
    #message-input { flex-grow: 1; }
  </style>
</head>
<body>
  <h1 id="title">Loading...</h1>
  <pre id="message-log"></pre>
  <div id="input-area">
    <input id="message-input" type="text" placeholder="Type a message..." />
    <button id="send-button">Send</button>
  </div>
</body>
</html>